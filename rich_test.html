<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" type="reset/css" href="assets/CSS/reset.css">
    <link rel="stylesheet" type="text/css" href="assets/CSS/style.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">

    <title>
        RICH - TEST PAGE</title>

    <style>






    </style>
</head>

<body>

    <div class="container">

        <h2>Rich's Test Page</h2>

        <form>

            <div id="feature_input" class="input-group">

                <select name="feature" class="custom-select" id="feature_options">
                    <option value="" selected>select a feature:</option>
                    <option value="RSRT">resort</option>
                    <option value="SPA">spa</option>
                    <option value="FT">fort</option>
                    <option value="CTRS">space center</option>
                    <option value="CTRR">religious center</option>
                    <option value="PAL">palace</option>
                    <option value="PGDA">pagoda</option>
                    <option value="CNYN">canyon</option>
                    <option value="PYR">pyramid</option>
                    <option value="PYRS">pyramids</option>
                    <option value="MESU">mesa</option>
                </select>

                <div class="input-group-append">
                    <input id="search_btn" type="submit" class="btn btn-primary" name="submit" value="SEARCH">
                </div>

            </div>

        </form>
        <br>
        <div class="input-group-append">
            <input id="wigle_btn" type="submit" class="btn btn-primary" name="submit" value="WIGLE!">
        </div>

    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>

    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
    <!-- <script type="text/javascript" src="assets/JS/script.js"></script> -->

    <script src="assets/JS/selectFeature.js"></script>

    <!-- <script src="assets/JS/script2.js"></script> -->



    <script>
        // START jQUERY FUNCTION
        // ==============================
        $(document).ready(function () {



            // ============================================================================================================
            // GET THE FEATURE CODE FROM THE VALUE OF THE OPTION SELECTED IN THE DROPDOWN LIST
            // ============================================================================================================

            // set variable to stand for the feature code of feature name selected from dropdown
            var featureCode;

            function getFeatureCode() {

                var fCode = $("form").serializeArray();

                featureCode = fCode[0].value;
            }

            $("select").on("change", getFeatureCode);



            // ============================================================================================================
            // GET LOCATIONS MATCHING FEATURE CODES FROM GEONAMES search SERVICE (1 credit, limit 2,000/hr, 30,000/mo)
            // ============================================================================================================

            // getFeatureName variables
            var featureName;
            var featureCountryName;
            var featureCountryCode;
            var featureLatitude;
            var featureLongitude;
            var featureLocation;


            function getFeatureName() {

                var geonamesSearchFeatures = "http://api.geonames.org/searchJSON?featureCode=" + featureCode + "&maxRows=1&username=ghostfountain";

                $.ajax({
                        url: geonamesSearchFeatures,
                        method: "GET"
                    })
                    .then(function (response) {

                        for (var i = 0; i < response.geonames.length; i++) {

                            featureName = response.geonames[i].name;
                            featureCountryCode = response.geonames[i].countryCode;
                            featureLatitude = response.geonames[i].lat;
                            featureLongitude = response.geonames[i].lng;
                            featureLocation = response.geonames[i].fclName;

                            if (response.geonames[i].countryName) {

                                featureCountryName = response.geonames[i].countryName;
                                console.log("DESTINATION: " + featureName + ", " + featureCountryName);

                            } else {

                                // featureCountryName = "";
                                console.log("DESTINATION: " + featureName);

                            }


                        }

                        getPostalCodes();

                    });
            }




            // ==========================================================================================================
            // GET CLOSEST POSTAL CODE TO FEATURE LOCATION LAT+LONG COORDINATES FROM EZCMD API (limit 10,000 calls/month)
            // ==========================================================================================================

            // getPostalCodes variables
            var nearPlaceName;
            var nearPlacePostalCode;
            var nearPlaceCountryCode;
            var nearPlaceCountryName;
            var nearPlaceDistance;


            function getPostalCodes() {

                var ezcmdPostalCodes = "https://ezcmd.com/apps/api_geo_postal_codes/nearby_locations_by_coords/866eaf56be3781d02011b80ebd0baef8/354?coords=" + featureLatitude + "," + featureLongitude + "&within=100&unit=Km";

                $.ajax({
                        url: ezcmdPostalCodes,
                        method: "GET"
                    })
                    .then(function (response) {

                        if (response.search_results.length > 0) {

                            nearPlaceName = response.search_results[0].place_name.trim();
                            nearPlacePostalCode = response.search_results[0].postal_code;
                            nearPlaceCountryCode = response.search_results[0].country_code;
                            nearPlaceCountryName = response.search_results[0].country_name;
                            nearPlaceDistance = Math.round(response.search_results[0].distance * 10) / 10;

                            console.log("CLOSEST CITY: " + nearPlaceName + " " + nearPlaceCountryCode + " " + nearPlacePostalCode + " (" + nearPlaceDistance + " km)");

                            getHotspots();

                        } else if (featureLocation) {
                            console.log("CLOSEST CITY: (" + featureLocation + ")");
                            // console.log("WIFI: no info");
                            return;
                        } else {
                            console.log("CLOSEST CITY: no info");
                            // console.log("WIFI: no info");
                            return;
                        }
                    });
            }




            // =====================================================================================
            // GET # OF WIFI HOTSPOTS BY POSTAL CODE FROM WIGLE API (service is beta, no set limits)
            // =====================================================================================

            // getHotspots variables
            var nearPlaceWifi = 0;
            var listPostalCode;
            var listHotSpots

            // mini function to format thousands of WiFi numbers to k format
            function kFormatter(num) {
                return num > 999 ? (num / 1000).toFixed(1) + 'k' : num
            }

            function getHotspots() {

                var wigleHotspots = "https://api.wigle.net/api/v2/stats/regions?country=" + nearPlaceCountryCode;

                // this API required sending its authentication name:token as a Basic Authorization HTTP header in Base64 ...
                // does that count as using a technology that we haven't discussed?
                $.ajax({
                        headers: {
                            'Authorization': 'Basic ' + btoa('AID544c0365fdcc8c2463ec21d3590bbd23:8891f56fb22400d107dd8ee49d2798ff'),
                        },
                        url: wigleHotspots,
                        method: "GET"
                    })
                    .then(function (response) {

                        for (var k = 0; k < response.postalCode.length; k++) {

                            listPostalCode = response.postalCode[k].postalCode;
                            listHotSpots = kFormatter(response.postalCode[k].count);

                            // console.log(listPostalCode);
                            // console.log(listHotSpots);

                            if (listPostalCode === nearPlacePostalCode) {

                                nearPlaceWifi = listHotSpots;

                                console.log("WIFI: " + nearPlaceName + " " + nearPlacePostalCode + " " + nearPlaceCountryCode + " has " + nearPlaceWifi + " hotspots");
                            }
                        }
                    });
            }

            // ============================================================================================================
            // END OF GLOBAL VARIABLES AND FUNCTIONS DECLARATIONS
            // ============================================================================================================


            // ============================================================================================================
            // APPLICATION'S TOP LEVEL FUNCTIONALITY: SET FEATURE TO SEARCH, and SEARCH BUTTON FUNCTION
            // ============================================================================================================

            $("#search_btn").on("click", function () {

                event.preventDefault();

                getFeatureName();

            });


            // END jQUERY FUNCTION
        });
        // ==============================
    </script>

</body>

</html>