<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" type="reset/css" href="assets/CSS/reset.css">
    <link rel="stylesheet" type="text/css" href="assets/CSS/style.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">

    <title>RICH - TEST PAGE</title>

    <style>






    </style>
</head>

<body>

    <div class="container">

        <h2>Rich's Test Page</h2>

        <form>

            <div id="feature_input" class="input-group">

                <select name="feature" class="custom-select" id="feature_options">
                    <option value="" selected>select a feature:</option>
                    <option value="RSRT">resort</option>
                    <option value="SPA">spa</option>
                    <option value="FT">fort</option>
                    <option value="CTRS">space center</option>
                    <option value="CTRR">religious center</option>
                    <option value="PAL">palace</option>
                    <option value="PGDA">pagoda</option>
                    <option value="CNYN">canyon</option>
                    <option value="PYR">pyramid</option>
                    <option value="PYRS">pyramids</option>
                    <option value="MESU">mesa</option>
                </select>

                <div class="input-group-append">
                    <input id="search_btn" type="submit" class="btn btn-primary" name="submit" value="SEARCH">
                </div>

            </div>

        </form>
        <br>
        <div class="input-group-append">
            <input id="wigle_btn" type="submit" class="btn btn-primary" name="submit" value="WIGLE!">
        </div>

    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>

    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
    <script type="text/javascript" src="assets/JS/script.js"></script>

    <script src="assets/JS/selectFeature.js"></script>


    <script>
        // START jQUERY FUNCTION
        // ----------------------------------------------------------------
        $(document).ready(function () {


            // -----------------------------------------------------
            // CODE BELOW SETS THE VALUE OF featureCode WHEN USER CHANGES <select> <option>
            // -----------------------------------------------------

            // FEATURE CODE (like: SPA) THAT WILL BE INSERTED INTO THE geonamesLocationURL
            var featureCode;

            // FUNCTION THAT GETS THE featureCode VALUE FROM THE <select> <option>
            function getFeatureCode() {

                // create a one-element Array from the value of <form> input 
                // .serializeArray() gives cleaner format than .serialize()
                var fCode = $("form").serializeArray();

                // set the value of featureCode to be the value of value { value: "SPA" } of first (only) object in Array
                featureCode = fCode[0].value;

            }

            // whenever user's search term changes, run getFeatureCode() to update the value of featureCode
            $("select").on("change", getFeatureCode);



            // -----------------------------------------------------
            // CODE BELOW INSERTS THE featureCode INTO THE API STRING,
            // AND MAKES THE AJAX CALL TO THE API, GETTING AN ARRAY OF MATCHING LOCATION OBJECTS
            // -----------------------------------------------------

            // WHEN THE "SEARCH" BUTTON IS CLICKED...
            $("#search_btn").on("click", function () {

                // stop all the default submit form behaviors
                event.preventDefault();

                // API URL TO GET LIST OF LOCATIONS THAT HAVE featureCode (search = 1 credit per request)
                var geonamesLocationURL = "http://api.geonames.org/searchJSON?featureCode=" + featureCode + "&maxRows=1&username=ghostfountain";

                // FIRST AJAX CALL TO GET LOCATIONS BASED ON FEATURE CODE (SEARCH TERM)
                $.ajax({
                        url: geonamesLocationURL,
                        method: "GET"
                    })
                    .then(function (response) {

                        // console.log(response);

                        // CREATE VARS FOR EACH FEATURE
                        var fName;
                        var fCountryName;
                        var fCountryCode;
                        var fLatitude;
                        var fLongitude;

                        // LOOP THAT SETS VAR VALUES FOR EACH FEATURE RETURNED BY THE featureCode SEARCH
                        for (let i = 0; i < response.geonames.length; i++) {

                            // SET VAR VALUES FOR EACH FEATURE
                            fName = response.geonames[i].name;
                            fCountryName = response.geonames[i].countryName;
                            fCountryCode = response.geonames[i].countryCode;
                            fLatitude = response.geonames[i].lat;
                            fLongitude = response.geonames[i].lng;

                            // DISPLAY THE FEATURE NAME AND COUNTRY
                            console.log("DESTINATION: " + fName + ", " + fCountryName);


                            // API KEY THAT FINDS NEAREST POPULATED AREAS (findNearbyPlaceName = 3 credits per request)
                            var geonamesNearbyPlaceName = "http://api.geonames.org/findNearbyPlaceNameJSON?lat=" + fLatitude + "&lng=" + fLongitude + "&radius=30&style=MEDIUM&maxRows=1&username=ghostfountain";

                            // SECOND AJAX CALL TO GET CLOSEST CITY TO THE FEATURE
                            $.ajax({
                                    url: geonamesNearbyPlaceName,
                                    method: "GET"
                                })
                                .then(function (response) {

                                    // console.log(response);

                                    // SET VARIABLE VALUES FOR THE FIRST (CLOSEST) CITY NEAR THE FEATURE
                                    var cityName = response.geonames[0].name;
                                    var cityCountry = response.geonames[0].countryName;
                                    var cityCountryCode = response.geonames[0].countryCode;
                                    var cityLat = response.geonames[0].lat;
                                    var cityLong = response.geonames[0].lng;
                                    var cityDistance = response.geonames[0].distance;
                                    var cityPopulation = response.geonames[0].population;

                                    console.log("CLOSEST CITY: " + cityName + ", " + cityCountryCode + ", (" + cityDistance + " km)");


                                    // geoNames POSTAL CODE SEARCH: TRY NOT TO USE THIS, TO LIMIT geoNames CREDIT USAGE (2 credits/request)
                                    // API KEY for POSTAL CODE SEARCH with city coordinates (requires placename or postalcode)
                                    // var geonamesFindNearbyPostalCodes = "http://api.geonames.org/findNearbyPostalCodesJSON?lat=" + cityLat + "&lng=" + cityLong + "&radius=10&maxRows=1&style=SHORT&country=" + cityCountryCode + "&localCountry=true&username=ghostfountain"

                                    // ALTERNATE POSTAL CODE SEARCH, TO CUT DOWN ON geoNames SEARCH CREDITS (THIS SERVICE: 10,000 hits/mo)
                                    // API KEY THAT FINDS A LIST OF POSTAL CODES BASED ON LAT and LONG COORDINATES
                                    // USE THE LAT AND LONG COORDINATES OF THE FEATURE, OR THE CITY? PROBABLY THE CITY.
                                    var geonamesFindNearbyPostalCodes = "https://ezcmd.com/apps/api_geo_postal_codes/nearby_locations_by_coords/866eaf56be3781d02011b80ebd0baef8/354?coords=" + cityLat + "," + cityLong;



                                    // THIRD AJAX CALL TO GET NEARBY POSTAL CODES
                                    // FROM THE LAT AND LONG OF THE NEARBY CITY OR FEATURE ITSELF
                                    $.ajax({
                                            url: geonamesFindNearbyPostalCodes,
                                            method: "GET"
                                        })
                                        .then(function (response) {

                                            // console log the JSON Object data that comes back from the API call
                                            // console.log(response);

                                            // THIS FOR LOOP NEEDS TO BE UPDATED FOR ezcmd API:

                                            // loop through all location Objects in the Array (response)
                                            for (let j = 0; j < response.postalCodes.length; j++) {

                                                let nearPlaceName = response.postalCodes[j].placeName.trim();
                                                let nearPlacePostalCode = response.postalCodes[j].postalCode;
                                                let nearPlaceCountryCode = response.postalCodes[j].countryCode;
                                                let nearPlaceDistance = response.postalCodes[j].distance;
                                                let nearPlaceWifi;
                                                // console.log("near: " + nearPlaceName +" "+ nearPlaceCountryCode +" "+ nearPlacePostalCode +" "+ nearPlaceDistance);
                                                // console.log("near: " + nearPlaceName +" "+ nearPlaceCountryCode +" "+ nearPlacePostalCode);


                                                // API KEY for WIGLE SEND COUNTRY CODE, GET ALL POSTAL CODES AND WIFI HOTSPOTS
                                                // var wigleHotspots = "https://api.wigle.net/api/v2/stats/regions?country=US";
                                                var wigleHotspots = "https://api.wigle.net/api/v2/stats/regions?country=" + nearPlaceCountryCode;

                                                // AJAX CALL for WIGLE SEND COUNTRY CODE, GET ALL POSTAL CODES AND WIFI HOTSPOTS
                                                // REQUIRES username:token AS A Base64 Basic Authorization HTTP Header
                                                $.ajax({
                                                        headers: {
                                                            'Authorization': 'Basic ' + btoa('AID544c0365fdcc8c2463ec21d3590bbd23:8891f56fb22400d107dd8ee49d2798ff'),
                                                        },
                                                        url: wigleHotspots,
                                                        method: "GET"
                                                    })
                                                    .then(function (response) {

                                                        // console.log(response);

                                                        for (let k = 0; k < response.postalCode.length; k++) {

                                                            let listPostalCode = response.postalCode[k].postalCode;
                                                            let listHotSpots = response.postalCode[k].count;

                                                            if (listPostalCode === nearPlacePostalCode) {

                                                                nearPlaceWifi = listHotSpots;

                                                                console.log("CLOSEST CITY: " + nearPlaceName + " " + nearPlaceCountryCode + " " + nearPlacePostalCode + " (" + nearPlaceDistance + " km) has " + nearPlaceWifi + " hotspots.");

                                                            }
                                                        }

                                                    });

                                            }

                                        });

                                });
                        }

                    });

            });




            // WHEN THE "WIGLE!" BUTTON IS CLICKED...
            $("#wigle_btn").on("click", function () {

                // stop all the default submit form behaviors
                event.preventDefault();

                // API KEY for WIGLE /api/v2/stats/regions
                // Get statistics for a specified country, organized by region
                // SEND COUNTRY CODE, GET BACK A LIST OF POSTAL CODES WITH NUMBER OF WIFI HOTSPOTS
                // var wigleHotspots = "https://api.wigle.net/api/v2/stats/regions?country=US";
                var wigleHotspots = "https://api.wigle.net/api/v2/stats/regions?country=US";

                // HERE'S THE AJAX CALL TO GET A LIST OF WIFI HOTSPOTS BY POSTAL CODE FROM WIGLE, BY COUNTRY
                // NOTE THIS REQUEST REQUIRES SENDING username:token AS A Base64 Basic Authorization HTTP Header
                $.ajax({
                        headers: {
                            'Authorization': 'Basic ' + btoa('AID544c0365fdcc8c2463ec21d3590bbd23:8891f56fb22400d107dd8ee49d2798ff'),
                        },
                        url: wigleHotspots,
                        method: "GET"
                    })
                    .then(function (response) {

                        // console.log(response);
                        // console.log(response.postalCode);
                        // console.log(response.postalCode[101]);
                        console.log(response.postalCode[101].count);
                        console.log(response.postalCode[101].postalCode);

                    });


            });

            // END jQUERY FUNCTION
        });
        // ----------------------------------------------------------------








        // =========================================================
        // ALTERNATE API FOR THE THIRD AJAX CALL, USING EZCMD INSTEAD OF GEONAMES
        // TO GET A LIST OF POSTAL CODES NEAR A SET OF LAT+LONG COORDINATES
        // =========================================================

        // Returns all neighbouring locations worldwide for a given pair of lat,long coordinates.
        // Example API call (click, don't be shy):
        // https://ezcmd.com/apps/api_ezip_locator/nearby_locations_by_coords/[API_KEY]/[USER_ID]
        // GET Parameters:
        // Mandatory:
        // coords=41.701627,-87.698364 // Latitude and Longitude pair of coordinates separated by comma.
        // Optional:
        // within=150 // The distance radius to search for neighbouring places within.
        // unit=Miles // Either Miles or Km (please mind the upper-case M and K).
        // group=place_name // Avoid duplicate results by grouping your results by any of the returned fields. Default grouping is by place_name. Group by id to get all zip codes.
        // start=0 // The results are paginated. The start offset. Limit is always 100.


        // API KEY THAT FINDS A LIST OF POSTAL CODES BASED ON LAT and LONG COORDINATES
        // USE THE LAT AND LONG COORDINATES OF THE FEATURE, OR THE CITY? PROBABLY THE CITY.
        // var ezcmdPostalCodes = "https://ezcmd.com/apps/api_geo_postal_codes/nearby_locations_by_coords/866eaf56be3781d02011b80ebd0baef8/354?coords=" + cityLat + "," + cityLong;

        // var ezcmdPostalCodes = "https://ezcmd.com/apps/api_geo_postal_codes/nearby_locations_by_coords/866eaf56be3781d02011b80ebd0baef8/354?coords=" + cityLat + "," + cityLong + "&within=10&unit=Km&group=" + cityName;

        // console.log for ezcmdPostalCodes postal_codes
        // console.log(response.search_results[0].postal_code);

        // =========================================================
        // =========================================================
        // =========================================================
    </script>

</body>

</html>